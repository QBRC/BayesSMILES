<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
        integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"
        integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous">
    <!-- Scroll to top CSS -->
    <link rel="stylesheet" href="scroll-to-top.css">

    <style>
        body {
          background-image: url('background.png');
          background-size: cover;
      }
    </style>
    
    <!-- Echarts JS -->
    <script src="echarts.min.js"></script>


    <title>COVID-19 Change Point Analysis for 50 States</title>
</head>

<body>
    <div class="container">
        <div class="d-flex bd-highlight">
            <div class="p-2 flex-fill bd-highlight">
                <h1>COVID-19 Change Point Analysis for 50 States</h1>
            </div>
            <div class="p-2 flex-fill bd-highlight">
                <h1><span data-toggle="modal" data-target="#exampleModal">
                        <i class="fa fa-info" aria-hidden="true"></i></span></h1>
            </div>
        </div>
    </div>
    <div class="container" id="container">
    </div>

    <!-- scroll-to-top button -->
    <a class="top-link hide" href="" id="js-top">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6">
            <path d="M12 6H0l6-6z" /></svg>
        <span class="screen-reader-text">Back to top</span>
    </a>

    <!-- Modal -->
    <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Help</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p>
                        <b>Introduction</b><br />
                        Coronavirus disease 2019 (COVID-19) is an ongoing global pandemic. Here we applied a novel Bayesian hierarchical model to detect multiple change points based on the daily actively infectious cases. This website demonstrates the analysis results. 
                    </p>
                    <p>
                        <b>Usage</b><br />
                        <a href="https://raw.githubusercontent.com/zhanxw/BayesSMILES/gh-pages/docs/screenshot.orig.png"><img src="screenshot.png"/></a>
                    </p>
                    <p>
                        <b>Cite</b><br />
                          BayesSMILES: Bayesian Segmentation Modeling for Longitudinal Epidemiological Study
                    </p>
                    <p>
                        <b>Contact</b><br />
                        <a href="mailto:Shuang.Jiang@UTSouthwestern.edu">Shuang Jiang</a>, <a href="mailto:Qiwei.Li@utdallas.edu">Qiwei Li</a>, <a href="mailto:Xiaowei.Zhan@UTSouthwestern.edu">Xiaowei Zhan</a>
                    </p>
                    <p>

                    </p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Optional JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"
        integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <!-- <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js"
        integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n"
        crossorigin="anonymous"></script> -->
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
        integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
        integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
        crossorigin="anonymous"></script>
    <script src="scroll-to-top.js"></script>
    <script type="text/javascript">
  
    drawSubPlot = function(data, idx, elementId) {
        const DATA = data;
        const i = idx;
        // based on prepared DOM, initialize echarts instance
        var myChart = echarts.init(document.getElementById(elementId));

        // specify chart configuration item and data
        // var death = [];
        // for (t = 0; t < 100; ++t) {
        //     death.push([t, Math.floor(Math.random() * 10)]);
        //     if (t > 0) {
        //         death[t][1] = death[t][1] + death[t - 1][1];
        //     }
        // }
        var infected = DATA[i]["infected"];
        // console.log(infected[0]);
        // console.log((new Date(infected[0][0])).getTime());
        // var min_infected = Math.min(... infected.map(x => x[1]));
        var min_infected = Math.min(... infected.map(x => x[1]));
        var max_infected = Math.max(... infected.map(x => x[1]));
        if (max_infected > 10000) {
            max_infected = Math.ceil(max_infected / 10000) * 10000;
        } else if (max_infected > 5000) {
            max_infected = Math.ceil(max_infected / 5000) * 5000;
        } else if (max_infected > 1000) {
            max_infected = Math.ceil(max_infected / 1000) * 1000;
        } else if (max_infected > 500) {
            max_infected = Math.ceil(max_infected / 500) * 500;
        } else if (max_infected > 250) {
            max_infected = Math.ceil(max_infected / 250) * 250;
        }
        var title = DATA[i]["name"];
        var changePoint = DATA[i]["changepoint"];
        var changePoint_line = changePoint.map( function(x) { 
            return {
                "name" : "CP", xAxis: x["estimate"][0], 
                "label": "<b>Change Point</b><br/>Estimate: " + x["estimate"][0] + 
                (x["span"].length === 2 ? "<br/>CI: " + x["span"][0] + " to " + x["span"][1] : "") } });            
        var changePoint_area = changePoint.map( function(x) { return {
            "span": x["span"],
            "label": "<b>Change Point</b><br/>Estimate: " + x["estimate"][0] + "<br/>CI: " + x["span"][0] + " to " + x["span"][1]}});
        changePoint_area = changePoint_area.filter(function(x) {return x["span"].length === 2});
        changePoint_area = changePoint_area.map(x => [ {label: x["label"], coord: [x["span"][0], max_infected * 0.1]}, {coord: [x["span"][1], max_infected * 0.9]}]);
        var r0 = DATA[i]["r0"];

        var r0_text = r0.map(x=>"<br/>Estimate: " + x["estimate"][0]+ "<br/>CI: " + x["ci"][0] + " to " + x["ci"][1] + "<br/>Segment: " + x["span"][0] + " to " + x["span"][1]);
        var r0_span = r0.map(x=>x["span"]);
        getMidDate = function (x) {
            // d1 = new Date("2020-03-25");
            // d2 = new Date("2020-03-30");
            // console.log(x);
            d1 = new Date(x[0]);
            d2 = new Date(x[1]);
            elapsed = d2.getTime() - d1.getTime();
            dMid = new Date();
            dMid.setTime(d1.getTime() + elapsed / 2);
            // console.log(x);
            return dMid.toJSON().substring(0, 10)
        }
        r0_span = r0_span.map(x => getMidDate(x));
        var r0_data = r0_span.map(x => [x, max_infected]);
        // console.log("i=", i, "title = ", title, "r0_text", r0_text);
        /// r0_text = ["1.3", "3.5", "4.5"]; //TODO
        var option = {
            title: {
                text: title
            },
            tooltip: {
                trigger: "item",
                formatter: function(params, ticket, cb) {

                    // console.log(params[0].componentType);
                    //     console.log(params[0]);     
                    if (params.componentType == "series") {
                        if (params.seriesName == "R0") {
                            return "<b>Reproduction number</b>" + r0_text[params.dataIndex];
                        } else if (params.componentSubType == "line") {
                           // console.log("line:", params);
                            return "Daily actively infectious count<br/>Date: " + params.data[0] + "<br/>Number: " + params.data[1]   ;
                        } else {
                            
                        }
                    } else if (params.componentType == "markLine") {
                        // console.log(params.data);
                        return params.data.label;
                        // return "Date: " + params.value;
                    } else if (params.componentType == "markArea") {
                        // console.log(params);
                        return params.data["label"];
                        // return "Confidence interval: <br/>" + 
                        // params.data["coord"][0][0] + 
                        // " to " + 
                        // params.data["coord"][1][0];
                    } else {
                        // console.log(params.componentType);
                        // console.log(params);                    
                    }
                    console.log(r0_text, "=>", params);    
                    console.log(params);
                }
            },
            grid: {
                left: "15%"
            },
            visualMap: [{
                show: false,
                type: 'continuous',
                seriesIndex: 0,
                min: min_infected,
                max: max_infected,
                inRange: {
                    color: ['#003000', '#003300']
                }
            }],
            // legend: {
            //     data:['Sales']
            // },
            xAxis: {
                type: 'time',
                boundaryGap: false,
                // Use callback function; function parameters are axis index
                axisLabel: {
                    formatter: function (value, index) {
                        // Formatted to be month/day; display year only in the first label
                        var date = new Date(value);
                        var texts = [(date.getMonth() + 1), date.getDate()];
                        // if (idx === 0) {
                        //     texts.unshift(date.getYear());
                        // }
                        return texts.join('/');
                    }
                }                
                // axisLabel: {
                //     formatter: function(value, idx) {
                //         console.log('xaxis formatter', value);
                //         var date = new Date(value);
                //         return idx === 0 ? value : [date.getMonth() + 1, date.getDate()].join('-');
                //     }
                // }
            },
            yAxis: {},
            series: [{
                name: 'Cumulative deaths',
                showSymbol: true,
                // smooth: 0.6,
                // symbol: 'none',
                type: 'line',
                itemStyle: {
                    opacity: 0
                },
                lineStyle: {
                    // color: 'green',
                    width: 2
                },
                data: infected,
                markLine: {
                    silent: false,
                    label: { show: false },
                    symbol: ['none', 'none'],
                    data: changePoint_line
                    // [
                    //     {
                    //         name: 'CP1',
                    //         xAxis: 37.5 // TODO
                    //     },
                    //     {
                    //         name: 'CP1',
                    //         xAxis: 67.5
                    //     }
                    // ]
                },
                markArea: {
                    silent: false,
                    symbol: ['none', 'none'],
                    label: { show: false },
                    data: changePoint_area
                    // [
                    //     [
                    //         { coord: [35, 20] }, // TODO
                    //         { coord: [40, 480] }
                    //     ],
                    //     [
                    //         { coord: [65, 20] },
                    //         { coord: [70, 480] }
                    //     ]]
                }
            }, {
                name: 'R0',
                data: r0_data, //[[18, 450], [53, 450], [83, 450]], //TODO
                type: "scatter",
                symbol: 'pin'
            }]
        };

        // use configuration item and data specified to show chart
        myChart.setOption(option);
        myChart.on('click', function (params) {
            // printing data name in console
            console.log(params);
        });
    }
    $.getJSON("us50states_JHU.json", function( data ) {
        DATA = data;
        //create 21 boxes
        var r = document.getElementById('container');
        var r2 = null;
        for (i = 0; i < DATA.length; ++i) {
            if (i % 3 == 0) {
                r2 = document.createElement("div");
                r2.className = "row";
                r.appendChild(r2);
            }
            var r3 = document.createElement("div");
            r3.className = "col-md-4 shadow";
            r3.id = 'main' + i;
            r3.style = "height:300px";
            r3.innerText = i;
            r2.appendChild(r3);
        }
        for (i = 0; i < DATA.length; ++i) {
            drawSubPlot(DATA, i, 'main' + i)
            
        }
    });
    </script>
    <script>
        $('#myModal').on('shown.bs.modal', function () {
            $('#myInput').trigger('focus')
        })
    </script>
</body>

</html>
